# Airflow Helm values for local Kind deployment
# Chart: apache-airflow/airflow (Airflow 3.x)
# Executor: LocalExecutor (no Redis/Celery overhead for a single-node Kind cluster)

executor: LocalExecutor

# Minimal resource requests so Kind doesn't OOM
scheduler:
  resources:
    requests:
      cpu: "200m"
      memory: "512Mi"
    limits:
      cpu: "500m"
      memory: "1Gi"

# Airflow 3.x uses apiServer instead of webserver for the UI
apiServer:
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"
    limits:
      cpu: "400m"
      memory: "512Mi"
  service:
    type: NodePort
    ports:
      - name: airflow-ui
        port: 8080
        targetPort: 8080
        nodePort: 30000

# Create default admin user
createUserJob:
  useHelmHooks: false
  applyCustomEnv: false

webserver:
  # Kept for compatibility; Airflow 3.x uses apiServer above
  defaultUser:
    enabled: true
    role: Admin
    username: admin
    email: admin@airflow.local
    firstName: Admin
    lastName: User
    password: admin

triggerer:
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"

dagProcessor:
  resources:
    requests:
      cpu: "100m"
      memory: "256Mi"

# Disable unused components
flower:
  enabled: false

redis:
  enabled: false

statsd:
  enabled: false

# DAGs: mount from ConfigMap (airflow-dags, created separately)
dags:
  gitSync:
    enabled: false
  persistence:
    enabled: false

# Global volumes applied to ALL Airflow pods (scheduler, api-server, etc.)
# Use subPath to avoid the ConfigMap symlink directory structure that causes
# Airflow's DAG walker to raise a "recursive loop" error.
volumes:
  - name: dag-files
    configMap:
      name: airflow-dags

volumeMounts:
  - name: dag-files
    mountPath: /opt/airflow/dags/gold_user_activity.py
    subPath: gold_user_activity.py

# Bundled PostgreSQL for Airflow's metadata database
postgresql:
  enabled: true
  image:
    tag: latest
  primary:
    resources:
      requests:
        cpu: "100m"
        memory: "256Mi"

# Logging: use local (stdout) â€” no S3/GCS needed
logs:
  persistence:
    enabled: false

# Fernet key for encrypting DB connections (fixed value for reproducibility)
fernetKey: "YlCImzjge_TeZc7VdbRYIGOjTZ-RNMj9OYGMFTa4qyE="

# Secret key for the webserver (fixed for reproducibility)
webserverSecretKey: "a8d3f7c2b1e4958067a3b2c1d4e5f678"